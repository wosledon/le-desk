# le-desk

## 远程桌面软件设计文档

### 一、项目简介

le-desk 是基于 .NET Core 技术栈开发的远程桌面软件，支持跨平台远程桌面访问、控制与文件传输，适用于企业和个人远程办公、技术支持等场景。

---

### 二、总体架构

- **客户端（Client）**：负责采集本地桌面画面、输入事件（鼠标、键盘），并与服务端通信。
- **服务端（Server）**：负责用户认证、会话管理、数据中转、权限控制等。
- **通信协议**：基于 WebSocket 或 gRPC 实现实时、低延迟的数据传输。
- **数据加密**：全程 TLS 加密，保障数据安全。

---

### 三、核心技术要点

1. **桌面采集与编码**
   - 使用跨平台桌面采集库（如 Windows 的 Desktop Duplication API，Linux 的 X11/Wayland，macOS 的 Quartz）。
   - 实时编码（H.264/VP8）以降低带宽消耗。

2. **输入事件同步**
   - 捕获远程端鼠标、键盘事件，通过协议实时同步到被控端。

3. **高效传输**
   - 利用 WebSocket/gRPC 实现低延迟双向通信。
   - 支持断点续传、丢包重传机制。

4. **安全机制**
   - 用户身份认证（JWT/OAuth2）。
   - TLS 加密通信。
   - 权限与会话管理。

5. **文件传输**
   - 支持大文件分片上传/下载。
   - 断点续传与权限校验。

6. **跨平台支持**
   - .NET Core 支持 Windows、Linux、macOS。
   - UI 可选用 Avalonia、Electron.NET 或 Web 前端（Blazor）。
   - **客户端技术推荐（不限于 .NET）：**
     - **Avalonia UI**（.NET）：纯 .NET 跨平台桌面框架，原生体验，适合高性能桌面应用。
     - **Electron/Electron.NET**：基于 Web 技术，界面丰富，跨平台，适合需要复杂界面的场景。
     - **Qt**（C++/Python/QML）：成熟的跨平台桌面开发框架，性能优良，适合对界面和性能有较高要求的项目。
     - **Flutter**（Dart）：支持桌面、Web、移动端，开发效率高，界面现代。
     - **Blazor WebAssembly**（.NET）：如需 Web 客户端，可用 Blazor 实现浏览器端远程桌面访问。
     - **React/Vue/Svelte + WebRTC/gRPC-Web**：纯前端实现，适合 Web 端远程桌面。
     - **移动端**：可用 Flutter、React Native、原生 iOS/Android 实现移动客户端。
   - **选择建议**：根据团队技术栈、目标平台和性能需求选择合适方案。桌面端推荐 Avalonia、Qt 或 Electron，Web 端推荐 Blazor 或主流前端框架，移动端推荐 Flutter 或原生。

---

### 四、技术细节

#### 1. 桌面采集与编码
- Windows：利用 DXGI Desktop Duplication API 获取屏幕帧。
- Linux：X11/Wayland 截屏，结合 FFmpeg 进行编码。
- macOS：Quartz Display Services。
- 编码采用 FFmpeg 或系统自带的硬件加速编码器。

#### 2. 输入事件处理
- 客户端监听鼠标、键盘事件，序列化后通过 WebSocket/gRPC 发送。
- 服务端解析事件并调用本地 API 注入输入。

#### 3. 通信协议
- 消息格式采用 Protobuf 或 JSON。
- 支持心跳包、重连机制，保证连接稳定。

##### gRPC 通信细节设计

1. **服务定义**
   - 使用 Protobuf 定义 gRPC 服务接口，包括桌面画面流、输入事件流、文件传输、会话管理等。
   - 主要服务示例：
     - `ScreenStreamService`：桌面画面双向流式传输。
     - `InputEventService`：输入事件双向流式传输。
     - `FileTransferService`：文件上传/下载流式传输。
     - `SessionService`：用户认证、会话心跳、状态同步。

2. **消息结构**
   - 桌面画面消息：包含帧数据（压缩后）、分辨率、时间戳等。
   - 输入事件消息：包含事件类型（鼠标/键盘）、坐标、按键码、事件时间等。
   - 文件传输消息：包含文件分片数据、索引、总大小、校验码等。
   - 会话消息：包含用户凭证、心跳时间、状态码等。

3. **流式通信**
   - 桌面画面和输入事件均采用双向流（Bidirectional Streaming），实现实时同步。
   - 文件传输采用客户端/服务端流（Client/Server Streaming），支持大文件分片传输。
   - 会话管理采用简单的请求-响应或服务端流，定期推送心跳。

4. **安全机制**
   - gRPC 通道启用 TLS 加密，防止数据泄露。
   - 每次调用需携带 JWT Token 进行身份校验。
   - 服务端对异常请求进行限流和黑名单处理。

5. **异常与重连处理**
   - 客户端检测到连接断开时自动重连，支持断点续传。
   - 服务端返回标准 gRPC 错误码，客户端根据错误类型进行相应处理。
   - 支持心跳检测，及时发现连接异常。

6. **性能优化**
   - 消息采用 Protobuf 紧凑编码，减少带宽消耗。
   - 支持压缩传输（如 gzip）。
   - 桌面帧采用关键帧+差异帧机制，进一步降低流量。

---

#### 4. 安全与权限
- 用户登录采用 JWT，所有接口需校验 Token。
- 会话超时自动断开，支持多用户隔离。

#### 5. 文件传输
- 文件分片上传，支持断点续传。
- 传输过程加密，校验完整性（MD5/SHA256）。

#### 6. UI 设计
- 客户端 UI 简洁，支持多会话切换。
- 支持全屏、窗口化、剪贴板同步等功能。

---

### 五、部署与运维

- 支持 Docker 部署，便于云端或本地部署。
- 日志记录与异常监控，便于问题追踪。

---

### 六、后续扩展

- 移动端支持（iOS/Android）。
- 多屏幕支持。
- 远程音频同步。

---

### 七、项目结构建议

建议采用分层、模块化的项目结构，便于开发、维护与扩展。示例结构如下：

```
le-desk/
├── src/
│   ├── LeDesk.Server/           # 服务端核心项目（gRPC服务、会话管理、认证等）
│   ├── LeDesk.Client.Wasm/      # 客户端核心项目（Blazor WebAssembly 实现，桌面画面、输入事件、UI等）
│   ├── LeDesk.Shared/           # 通用模型、协议定义（Protobuf、DTO等）
│   └── LeDesk.Tools/            # 工具类、辅助脚本
├── proto/                       # gRPC Protobuf 协议文件
├── docs/                        # 设计文档、接口文档等
├── tests/                       # 单元测试与集成测试
├── deploy/                      # 部署脚本与Docker配置
├── README.md
└── ...（其他配置文件）
```

**说明：**
- `LeDesk.Server`：负责所有服务端逻辑，包括gRPC服务实现、用户认证、会话与权限管理、文件中转等。
- `LeDesk.Client.Wasm`：客户端采用 Blazor WebAssembly 技术栈，实现浏览器端远程桌面访问、输入事件同步、文件传输等功能。
- `LeDesk.Shared`：存放通用的数据结构、协议定义、工具方法等，供客户端和服务端共用。
- `proto`：集中管理所有Protobuf协议文件，便于维护和生成代码。
- `tests`：包含服务端、客户端的单元测试和集成测试。
- `deploy`：包含Dockerfile、CI/CD脚本等部署相关内容。
- `docs`：存放详细设计、接口说明、开发规范等文档。

---